#:kivy 2.0.0
#:import utils kivy.utils

<DarkIconButton@MDIconButton>:
    style: "filled"
    theme_bg_color: "Custom"
    md_bg_color: utils.get_color_from_hex('#383838')
    theme_icon_color: "Custom"
    icon_color: 1, 1, 1, 1

<PrimaryIconButton@MDIconButton>:
    style: "filled"
    theme_bg_color: "Custom"
    md_bg_color: utils.get_color_from_hex('#0e639c')
    theme_icon_color: "Custom"
    icon_color: 1, 1, 1, 1

<PanelTitle@MDLabel>:
    size_hint_y: None
    height: '25dp'
    font_style: "Label"
    role: "small"
    theme_text_color: "Custom"
    text_color: utils.get_color_from_hex('#858585')
    md_bg_color: utils.get_color_from_hex('#252526')
    padding: "15dp", "0dp", "0dp", "0dp"
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex('#2d2d2d')
        Line:
            points: [self.x, self.y, self.right, self.y]
            width: 1

<DisplayPanel@MDBoxLayout>:
    orientation: 'vertical'
    md_bg_color: utils.get_color_from_hex('#252526')

<RootLayout>:
    orientation: 'vertical'
    md_bg_color: utils.get_color_from_hex('#1e1e1e')  

    MDBoxLayout:
        size_hint_y: None
        height: '55dp'
        padding: '15dp', '10dp'
        spacing: '15dp'
        md_bg_color: utils.get_color_from_hex('#333333')
        canvas.before:
            Color:
                rgba: utils.get_color_from_hex('#3e3e42')
            Line:
                points: [self.x, self.y, self.right, self.y]
                width: 1

        # 1. ESSENTIAL: Run Button (Fixed width)
        MDBoxLayout:
            size_hint_x: None
            width: '140dp' 
            size_hint_y: None
            height: '40dp'

            AnchorLayout:
                anchor_x: 'center'
                anchor_y: 'center'

                MDButton:
                    id: btn_run
                    style: "filled"
                    theme_bg_color: "Custom"
                    md_bg_color: utils.get_color_from_hex('#0e639c')
                    on_release: root.start_visualization(self)
                    
                    MDButtonIcon:
                        id: btn_run_icon
                        icon: 'rocket-launch'
                        theme_icon_color: "Custom"
                        icon_color: 1, 1, 1, 1
                        
                    MDButtonText:
                        id: btn_run_text
                        text: 'Run'
                        theme_text_color: "Custom"
                        text_color: 1, 1, 1, 1

        # 2. ESSENTIAL: Playback Controls (Fixed minimum width so they never squish)
        MDBoxLayout:
            size_hint_x: None
            width: self.minimum_width  # Hugs the 3 buttons perfectly
            spacing: '10dp'
            
            DarkIconButton:
                icon: 'step-backward'
                on_release: root.step_visualization(-1)
                
            PrimaryIconButton:
                id: btn_play
                icon: 'play'
                on_release: root.toggle_play(self)
                
            DarkIconButton:
                icon: 'step-forward'
                on_release: root.step_visualization(1)

        ScrollView:
            size_hint_x: 1
            do_scroll_y: False
            do_scroll_x: True  
            bar_width: 0  

            MDBoxLayout:
                # THE MAGIC TRICK: Expand to fill the screen, but never crush smaller than 450dp
                size_hint_x: None
                width: max(dp(450), self.parent.width if self.parent else 0)
                spacing: '20dp'

                # Step Scrubber (Flexible - Takes up all the extra space!)
                MDBoxLayout:
                    size_hint_x: 1  
                    spacing: '10dp'
                    
                    MDSlider:
                        id: step_scrubber
                        min: 0
                        max: 1
                        value: 0
                        disabled: True
                        step: 1
                        size_hint_x: 1
                        on_value: root.render_step(int(self.value))
                        
                    MDLabel:
                        id: step_label
                        text: '0 / 0'
                        font_name: 'RobotoMono-Regular'
                        font_size: '12sp'
                        theme_text_color: "Custom"
                        text_color: utils.get_color_from_hex('#858585')
                        size_hint_x: None
                        width: '100dp'  # Increased from 60dp to fit up to 9999 / 9999
                        halign: 'right'
                        valign: 'center'
                        text_size: self.size  # Locks the text boundary
                        shorten: True         # Prevents it from EVER creating a new line
                        shorten_from: 'right'

                # Speed Slider (Fixed width so the text and slider stay predictable)
                MDBoxLayout:
                    size_hint_x: None
                    width: '200dp'
                    spacing: '10dp'
                    padding: [0, 0, '15dp', 0]
                    
                    MDLabel:
                        text: f'Speed: {speed_slider.value:.1f}x'
                        font_name: 'RobotoMono-Regular'
                        font_size: '12sp'
                        theme_text_color: "Custom"
                        text_color: utils.get_color_from_hex('#858585')
                        size_hint_x: None
                        width: '90dp'
                        halign: 'right'
                        valign: 'center'
                        text_size: self.size
                        shorten: True
                        shorten_from: 'right'
                        
                    MDSlider:
                        id: speed_slider
                        min: 0.1
                        max: 2.0
                        value: 1.0
                        size_hint_x: 1
                        on_value: root.update_speed(self.value)


    MDLabel:
        id: error_banner
        size_hint_y: None
        height: '0dp'
        text: ''
        markup: True
        halign: 'left'
        valign: 'center'
        theme_text_color: "Custom"
        text_color: utils.get_color_from_hex('#ffdddd')
        md_bg_color: utils.get_color_from_hex('#5a1d1d')
        padding: "10dp", "0dp", "0dp", "0dp"
        canvas.before:
            Color:
                rgba: utils.get_color_from_hex('#ff0000')
            Line:
                points: [self.x, self.y, self.right, self.y]
                width: 1

    MDBoxLayout:
        orientation: 'horizontal'
        
        MDBoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.6
            
            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: 0.7
                md_bg_color: utils.get_color_from_hex('#1e1e1e')
                
                PanelTitle:
                    text: ' CODE EDITOR'
                MDBoxLayout:
                    id: editor_wrapper
                    orientation: 'horizontal'
                    opacity: 1
                    
                    TextInput:
                        id: line_numbers
                        size_hint_x: None
                        width: '55dp'
                        text: '  1'
                        readonly: True
                        background_color: utils.get_color_from_hex('#1e1e1e')
                        foreground_color: utils.get_color_from_hex('#6e7681')
                        font_name: 'RobotoMono-Regular'
                        font_size: '14sp'
                        halign: 'right'
                        padding: [0, '10dp', '8dp', '10dp']
                        cursor_color: (0, 0, 0, 0)
                        scroll_y: code_input.scroll_y

                    CodeInput:
                        id: code_input
                        lexer: __import__('pygments.lexers.python').lexers.python.PythonLexer()
                        style_name: 'monokai'
                        text: ''
                        background_color: utils.get_color_from_hex('#1e1e1e')
                        foreground_color: utils.get_color_from_hex('#c9d1d9')
                        cursor_color: utils.get_color_from_hex('#58a6ff')
                        font_name: 'RobotoMono-Regular'
                        font_size: '14sp'
                        auto_indent: True
                        readonly: False
                        padding: ['15dp', '10dp']

                ScrollView:
                    id: trace_wrapper
                    do_scroll_x: True
                    do_scroll_y: True
                    opacity: 0
                    size_hint_y: None
                    height: 0
                    
                    MDBoxLayout:
                        orientation: 'horizontal'
                        size_hint: None, None
                        height: max(trace_line_numbers.texture_size[1], code_display.texture_size[1]) if (trace_line_numbers.texture_size and code_display.texture_size) else 0
                        width: max(trace_wrapper.width, trace_line_numbers.width + code_display.texture_size[0]) if code_display.texture_size else trace_wrapper.width
                        
                        Label:
                            id: trace_line_numbers
                            size_hint: None, None
                            size: '55dp', self.texture_size[1]
                            text_size: self.width, None
                            pos_hint: {'top': 1}
                            text: ''
                            color: utils.get_color_from_hex('#6e7681')
                            font_name: 'RobotoMono-Regular'
                            font_size: '14sp'
                            halign: 'right'
                            valign: 'top'
                            padding: [0, '10dp', '8dp', '10dp']
                            markup: True

                        Label:
                            id: code_display
                            text: ''
                            markup: True
                            color: utils.get_color_from_hex('#d4d4d4')
                            text_size: max(self.width, self.texture_size[0] if self.texture_size else 0), None
                            size_hint: None, None
                            size: max(self.parent.width - trace_line_numbers.width if self.parent and trace_line_numbers else 0, self.texture_size[0] if self.texture_size else 0), self.texture_size[1] if self.texture_size else 0
                            pos_hint: {'top': 1}
                            halign: 'left'
                            valign: 'top'
                            font_name: 'RobotoMono-Regular'
                            font_size: '14sp'
                            padding: ['15dp', '10dp']

            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: 0.3
                md_bg_color: utils.get_color_from_hex('#181818')
                canvas.before:
                    Color:
                        rgba: utils.get_color_from_hex('#3e3e42')
                    Line:
                        points: [self.x, self.top, self.right, self.top]
                        width: 1

                PanelTitle:
                    text: ' TERMINAL / OUTPUT'
                    
                ScrollView:
                    do_scroll_x: True
                    do_scroll_y: True
                    Label:
                        id: output_display
                        text: ''
                        color: utils.get_color_from_hex('#dcdcdc')
                        size_hint: None, None
                        size: self.texture_size
                        halign: 'left'
                        valign: 'top'
                        font_name: 'RobotoMono-Regular'
                        font_size: '13sp'
                        padding: ['10dp', '10dp']

        MDBoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.4
            canvas.before:
                Color:
                    rgba: utils.get_color_from_hex('#3e3e42')
                Line:
                    points: [self.x, self.y, self.x, self.top]
                    width: 1

            DisplayPanel:
                size_hint_y: 0.6
                PanelTitle:
                    text: ' VARIABLES'
                ScrollView:
                    do_scroll_x: True
                    do_scroll_y: True
                    Label:
                        id: variable_display
                        text: ''
                        color: utils.get_color_from_hex('#cccccc')
                        size_hint: None, None
                        size: self.texture_size
                        halign: 'left'
                        valign: 'top'
                        font_name: 'RobotoMono-Regular'
                        font_size: '13sp'
                        padding: ['10dp', '10dp']
                        markup: True

            DisplayPanel:
                size_hint_y: 0.4
                canvas.before:
                    Color:
                        rgba: utils.get_color_from_hex('#3e3e42')
                    Line:
                        points: [self.x, self.top, self.right, self.top]
                        width: 1
                PanelTitle:
                    text: ' CALL STACK'
                ScrollView:
                    do_scroll_x: True
                    do_scroll_y: True
                    Label:
                        id: memory_display
                        text: ''
                        color: utils.get_color_from_hex('#aaaaaa')
                        size_hint: None, None
                        size: self.texture_size
                        halign: 'left'
                        valign: 'top'
                        font_name: 'RobotoMono-Regular'
                        font_size: '13sp'
                        padding: ['12dp', '6dp']
                        markup: True
