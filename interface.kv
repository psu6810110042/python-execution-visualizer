#:kivy 2.0.0
#:import utils kivy.utils

# --- Custom Splitter for Resizing ---
<LoadSplitter@Splitter>:
    strip_size: '10dp'
    min_size: '100dp'
    rescale_with_parent: True
    # Visual style for the drag strip
    canvas.after:
        Color:
            rgba: utils.get_color_from_hex('#444444')
        Rectangle:
            pos: self.pos if self.sizable_from == 'left' or self.sizable_from == 'bottom' else (self.right - self.strip_size, self.y) if self.sizable_from == 'right' else (self.x, self.top - self.strip_size)
            size: (self.strip_size, self.height) if self.sizable_from in ['left', 'right'] else (self.width, self.strip_size)
        # Add a little "grip" icon (dots) in the center of the strip
        Color:
            rgba: utils.get_color_from_hex('#666666')
        Ellipse:
            pos: (self.center_x - 2, self.y + self.height/2 - 2) if self.sizable_from in ['left', 'right'] else (self.x + self.width/2 - 2, self.center_y - 2)
            size: 4, 4

<DarkIconButton@MDIconButton>:
    style: "filled"
    theme_bg_color: "Custom"
    md_bg_color: utils.get_color_from_hex('#383838')
    theme_icon_color: "Custom"
    icon_color: 1, 1, 1, 1

<PrimaryIconButton@MDIconButton>:
    style: "filled"
    theme_bg_color: "Custom"
    md_bg_color: utils.get_color_from_hex('#0e639c')
    theme_icon_color: "Custom"
    icon_color: 1, 1, 1, 1

<PanelTitle@MDBoxLayout>:
    size_hint_y: None
    height: '25dp'
    md_bg_color: utils.get_color_from_hex('#252526')
    padding: "0dp", "0dp", "0dp", "0dp"
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex('#2d2d2d')
        Line:
            points: [self.x, self.y, self.right, self.y]
            width: 1

<DisplayPanel@MDBoxLayout>:
    orientation: 'vertical'
    md_bg_color: utils.get_color_from_hex('#252526')

<RootLayout>:
    orientation: 'vertical'
    md_bg_color: utils.get_color_from_hex('#1e1e1e')  

    # --- TOP TOOLBAR ---
    MDBoxLayout:
        size_hint_y: None
        height: '55dp'
        padding: '15dp', '10dp'
        spacing: '15dp'
        md_bg_color: utils.get_color_from_hex('#333333')
        canvas.before:
            Color:
                rgba: utils.get_color_from_hex('#3e3e42')
            Line:
                points: [self.x, self.y, self.right, self.y]
                width: 1

        MDBoxLayout:
            size_hint_x: None
            width: '140dp' 
            size_hint_y: None
            height: '40dp'

            AnchorLayout:
                anchor_x: 'center'
                anchor_y: 'center'

                MDButton:
                    id: btn_run
                    style: "filled"
                    theme_bg_color: "Custom"
                    md_bg_color: utils.get_color_from_hex('#0e639c')
                    on_release: root.start_visualization(self)
                     
                    MDButtonIcon:
                        id: btn_run_icon
                        icon: 'rocket-launch'
                        theme_icon_color: "Custom"
                        icon_color: 1, 1, 1, 1
                        
                    MDButtonText:
                        id: btn_run_text
                        text: 'Run'
                        theme_text_color: "Custom"
                        text_color: 1, 1, 1, 1

        MDBoxLayout:
            size_hint_x: None
            width: '36dp'
            size_hint_y: None
            height: '36dp'

            AnchorLayout:
                anchor_x: 'center'
                anchor_y: 'center'

                DarkIconButton:
                    id: btn_examples
                    icon: 'code-tags'
                    on_release: root.open_examples_menu(self)

        MDBoxLayout:
            size_hint_x: None
            width: self.minimum_width
            spacing: '10dp'
            
            DarkIconButton:
                icon: 'step-backward'
                on_release: root.step_visualization(-1)
                
            PrimaryIconButton:
                id: btn_play
                icon: 'play'
                on_release: root.toggle_play(self)
                
            DarkIconButton:
                icon: 'step-forward'
                on_release: root.step_visualization(1)

        ScrollView:
            size_hint_x: 1
            do_scroll_y: False
            do_scroll_x: True  
            bar_width: 0  

            MDBoxLayout:
                size_hint_x: None
                width: max(dp(450), self.parent.width if self.parent else 0)
                spacing: '20dp'

                MDBoxLayout:
                    size_hint_x: 1  
                    spacing: '10dp'
                    
                    MDSlider:
                        id: step_scrubber
                        min: 0
                        max: 1
                        value: 0
                        disabled: True
                        step: 1
                        size_hint_x: 1
                        on_value: root.render_step(int(self.value))
                        
                    MDLabel:
                        id: step_label
                        text: '0 / 0'
                        font_name: 'RobotoMono-Regular'
                        font_size: '12sp'
                        theme_text_color: "Custom"
                        text_color: utils.get_color_from_hex('#858585')
                        size_hint_x: None
                        width: '100dp'
                        halign: 'right'
                        valign: 'center'
                        text_size: self.size
                        shorten: True 
                        shorten_from: 'right'

                MDBoxLayout:
                    size_hint_x: None
                    width: '200dp'
                    spacing: '10dp'
                    padding: [0, 0, '15dp', 0]
                    
                    MDLabel:
                        text: f'Speed: {speed_slider.value:.1f}x'
                        font_name: 'RobotoMono-Regular'
                        font_size: '12sp'
                        theme_text_color: "Custom"
                        text_color: utils.get_color_from_hex('#858585')
                        size_hint_x: None
                        width: '90dp'
                        halign: 'right'
                        valign: 'center'
                        text_size: self.size
                        shorten: True
                        shorten_from: 'right'
                        
                    MDSlider:
                        id: speed_slider
                        min: 0.1
                        max: 5.0
                        value: 1.0
                        size_hint_x: 1
                        on_value: root.update_speed(self.value)

    # --- ERROR BANNER ---
    MDLabel:
        id: error_banner
        size_hint_y: None
        height: '0dp'
        text: ''
        markup: True
        halign: 'left'
        valign: 'center'
        theme_text_color: "Custom"
        text_color: utils.get_color_from_hex('#ffdddd')
        md_bg_color: utils.get_color_from_hex('#5a1d1d')
        padding: "10dp", "0dp", "0dp", "0dp"
        canvas.before:
            Color:
                rgba: utils.get_color_from_hex('#ff0000')
            Line:
                points: [self.x, self.y, self.right, self.y]
                width: 1

    # --- MAIN CONTENT AREA ---
    MDBoxLayout:
        orientation: 'horizontal'
        
        # === 1. LEFT PANEL (Editor + Terminal) ===
        # Wrapped in LoadSplitter to resize against the Right Panel
        LoadSplitter:
            id: left_splitter
            sizable_from: 'right'
            size_hint_x: 0.6
            min_size: '300dp'
            max_size: root.width - dp(200)

            MDBoxLayout:
                orientation: 'vertical'
                
                # === 2. TOP LEFT (Code Editor) ===
                LoadSplitter:
                    id: editor_splitter
                    sizable_from: 'bottom'
                    size_hint_y: 0.7
                    min_size: '150dp'
                    max_size: self.parent.height - dp(100)

                    MDBoxLayout:
                        id: editor_panel
                        orientation: 'vertical'
                        md_bg_color: utils.get_color_from_hex('#1e1e1e')
                        
                        PanelTitle:
                            MDLabel:
                                text: ' CODE EDITOR'
                                font_style: "Label"
                                role: "small"
                                theme_text_color: "Custom"
                                text_color: utils.get_color_from_hex('#858585')
                                padding: "15dp", "0dp", "0dp", "0dp"
                            MDIconButton:
                                icon: 'chevron-down'
                                icon_size: '14sp'
                                size_hint: None, None
                                size: '24dp', '24dp'
                                theme_icon_color: "Custom"
                                icon_color: utils.get_color_from_hex('#858585')
                                on_release: root.toggle_panel('terminal')

                        MDBoxLayout:
                            id: editor_wrapper
                            orientation: 'horizontal'
                            opacity: 1
                            
                            TextInput:
                                id: line_numbers
                                size_hint_x: None
                                width: '55dp'
                                text: '  1'
                                readonly: True
                                background_color: utils.get_color_from_hex('#1e1e1e')
                                foreground_color: utils.get_color_from_hex('#6e7681')
                                font_name: 'RobotoMono-Regular'
                                font_size: '14sp'
                                halign: 'right'
                                padding: [0, '10dp', '8dp', '10dp']
                                cursor_color: (0, 0, 0, 0)
                                scroll_y: code_input.scroll_y

                            CodeInput:
                                id: code_input
                                lexer: __import__('pygments.lexers.python').lexers.python.PythonLexer()
                                style_name: 'monokai'
                                text: ''
                                background_color: utils.get_color_from_hex('#1e1e1e')
                                foreground_color: utils.get_color_from_hex('#c9d1d9')
                                cursor_color: utils.get_color_from_hex('#58a6ff')
                                font_name: 'RobotoMono-Regular'
                                font_size: '14sp'
                                auto_indent: True
                                readonly: False
                                padding: ['15dp', '10dp']
                                on_focus: root.set_editor_focus(self.focus)

                        ScrollView:
                            id: trace_wrapper
                            do_scroll_x: True
                            do_scroll_y: True
                            opacity: 0
                            size_hint_y: None
                            height: 0
                            
                            MDBoxLayout:
                                orientation: 'horizontal'
                                size_hint: None, None
                                height: max(trace_line_numbers.texture_size[1], code_display.texture_size[1]) if (trace_line_numbers.texture_size and code_display.texture_size) else 0
                                width: max(trace_wrapper.width, trace_line_numbers.width + code_display.texture_size[0]) if code_display.texture_size else trace_wrapper.width
                                
                                Label:
                                    id: trace_line_numbers
                                    size_hint: None, None
                                    size: '55dp', self.texture_size[1]
                                    text_size: self.width, None
                                    pos_hint: {'top': 1}
                                    text: ''
                                    color: utils.get_color_from_hex('#6e7681')
                                    font_name: 'RobotoMono-Regular'
                                    font_size: '14sp'
                                    halign: 'right'
                                    valign: 'top'
                                    padding: [0, '10dp', '8dp', '10dp']
                                    markup: True

                                Label:
                                    id: code_display
                                    text: ''
                                    markup: True
                                    color: utils.get_color_from_hex('#d4d4d4')
                                    text_size: max(self.width, self.texture_size[0] if self.texture_size else 0), None
                                    size_hint: None, None
                                    size: max(self.parent.width - trace_line_numbers.width if self.parent and trace_line_numbers else 0, self.texture_size[0] if self.texture_size else 0), self.texture_size[1] if self.texture_size else 0
                                    pos_hint: {'top': 1}
                                    halign: 'left'
                                    valign: 'top'
                                    font_name: 'RobotoMono-Regular'
                                    font_size: '14sp'
                                    padding: ['15dp', '10dp']

                # === 3. BOTTOM LEFT (Terminal) ===
                MDBoxLayout:
                    id: terminal_panel
                    orientation: 'vertical'
                    md_bg_color: utils.get_color_from_hex('#181818')
                    canvas.before:
                        Color:
                            rgba: utils.get_color_from_hex('#3e3e42')
                        Line:
                            points: [self.x, self.top, self.right, self.top]
                            width: 1

                    PanelTitle:
                        MDLabel:
                            text: ' TERMINAL / OUTPUT'
                            font_style: "Label"
                            role: "small"
                            theme_text_color: "Custom"
                            text_color: utils.get_color_from_hex('#858585')
                            padding: "15dp", "0dp", "0dp", "0dp"
                        MDIconButton:
                            id: terminal_toggle_btn
                            icon: 'chevron-down'
                            icon_size: '14sp'
                            size_hint: None, None
                            size: '24dp', '24dp'
                            theme_icon_color: "Custom"
                            icon_color: utils.get_color_from_hex('#858585')
                            on_release: root.toggle_panel('terminal')
                        
                    InteractiveTerminal:
                        id: terminal_display

        # === 4. RIGHT PANEL (Variables + Stack) ===
        MDBoxLayout:
            id: right_panel
            orientation: 'vertical'
            canvas.before:
                Color:
                    rgba: utils.get_color_from_hex('#3e3e42')
                Line:
                    points: [self.x, self.y, self.x, self.top]
                    width: 1

            # === 5. TOP RIGHT (Variables) ===
            LoadSplitter:
                sizable_from: 'bottom'
                size_hint_y: 0.45
                min_size: '100dp'
                max_size: self.parent.height - dp(150)

                DisplayPanel:
                    PanelTitle:
                        MDLabel:
                            text: ' VARIABLES'
                            font_style: "Label"
                            role: "small"
                            theme_text_color: "Custom"
                            text_color: utils.get_color_from_hex('#858585')
                            padding: "15dp", "0dp", "0dp", "0dp"
                        MDIconButton:
                            icon: 'chevron-right'
                            icon_size: '14sp'
                            size_hint: None, None
                            size: '24dp', '24dp'
                            theme_icon_color: "Custom"
                            icon_color: utils.get_color_from_hex('#858585')
                            on_release: root.toggle_panel('right')
                    ScrollView:
                        do_scroll_x: True
                        do_scroll_y: True
                        Label:
                            id: variable_display
                            text: ''
                            color: utils.get_color_from_hex('#cccccc')
                            size_hint: None, None
                            size: self.texture_size
                            halign: 'left'
                            valign: 'top'
                            font_name: 'RobotoMono-Regular'
                            font_size: '13sp'
                            padding: ['10dp', '10dp']
                            markup: True

            # === 6. BOTTOM RIGHT (Call Stack) ===
            DisplayPanel:
                # size_hint_y is handled by the Splitter above
                canvas.before:
                    Color:
                        rgba: utils.get_color_from_hex('#3e3e42')
                    Line:
                        points: [self.x, self.top, self.right, self.top]
                        width: 1
                PanelTitle:
                    text: ' CALL STACK'
                ScrollView:
                    do_scroll_x: True
                    do_scroll_y: True
                    Label:
                        id: memory_display
                        text: ''
                        color: utils.get_color_from_hex('#aaaaaa')
                        size_hint: None, None
                        size: self.texture_size
                        halign: 'left'
                        valign: 'top'
                        font_name: 'RobotoMono-Regular'
                        font_size: '13sp'
                        padding: ['12dp', '6dp']
                        markup: True
